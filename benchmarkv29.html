<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CyberBench 30.0: Hierarchy Fix</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=JetBrains+Mono:wght@400;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --brand-primary: #ff003c; /* Chaos Red */
            --brand-secondary: #00f3ff; /* Cyan */
            --brand-yellow: #facc15; /* Prod Yellow */
            --brand-green: #10b981; /* Create Green */
            --brand-ai: #bc13fe; /* AI Purple */
            --bg-dark: #000000;
            --panel-bg: rgba(5, 5, 5, 0.96);
        }

        body {
            background-color: var(--bg-dark);
            color: #fff;
            font-family: 'JetBrains Mono', monospace;
            overflow: hidden;
            user-select: none;
        }

        .font-cyber { font-family: 'Orbitron', sans-serif; }

        /* RENDER LAYERS */
        #render-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 0;
            background: #000;
        }
        
        canvas#cpu-canvas {
            width: 100%; height: 100%;
            display: block;
            image-rendering: pixelated;
            opacity: 0;
            transition: opacity 0.5s;
        }

        #gpu-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1;
            opacity: 0;
            transition: opacity 0.5s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #gpu-overlay canvas {
            max-width: 100%; max-height: 100%; object-fit: contain;
        }

        /* UI */
        #ui-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10;
            pointer-events: none; 
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .panel {
            background: var(--panel-bg);
            border: 1px solid #333;
            backdrop-filter: blur(20px);
            pointer-events: auto;
            box-shadow: 0 0 100px rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
        }

        .btn-main {
            background: #111; border: 1px solid #333; color: #fff;
            text-transform: uppercase; font-weight: 800; letter-spacing: 2px; transition: 0.2s;
        }
        .btn-main:hover { background: #fff; color: #000; box-shadow: 0 0 20px white; }
        
        .btn-oc {
            background: linear-gradient(90deg, #220000, #000);
            border: 1px solid #ff003c; color: #ff003c; text-shadow: 0 0 5px #ff003c;
        }
        .btn-oc.active {
            background: #ff003c; color: #000; box-shadow: 0 0 40px #ff003c; text-shadow: none;
        }

        .render-bucket {
            position: absolute;
            border: 1px solid rgba(0, 243, 255, 0.8);
            background: rgba(0, 243, 255, 0.1);
            z-index: 5;
            display: flex;
            align-items: start; justify-content: start;
            padding: 1px; font-size: 8px; color: #00f3ff; font-weight: bold;
        }

        .progress-track { background: #111; height: 6px; width: 100%; margin-top: 10px; border: 1px solid #333; }
        .progress-fill { height: 100%; width: 0%; background: var(--brand-secondary); transition: width 0.2s; }
        .score-box { border: 1px solid #333; background: rgba(0,0,0,0.8); padding: 15px; }
        
        .menu-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-bottom: 2rem;
        }
        .menu-item {
            border: 1px solid #333;
            background: rgba(255,255,255,0.03);
            padding: 1rem;
            transition: all 0.2s;
        }
        .menu-item:hover {
            background: rgba(255,255,255,0.08);
            border-color: #666;
        }
        
        .log-line {
            font-family: monospace;
            font-size: 10px;
            color: #666;
            margin-bottom: 2px;
        }
    </style>
</head>
<body>

    <div id="render-layer"><canvas id="cpu-canvas"></canvas></div>
    <div id="gpu-overlay"></div>

    <div id="ui-layer">
        <!-- MENU -->
        <div id="panel-menu" class="panel w-full max-w-7xl p-10 relative border-t-4 border-t-white">
            <div class="flex justify-between items-start mb-10 border-b border-gray-800 pb-6">
                <div>
                    <h1 class="font-cyber text-6xl mb-2 text-white">CYBER<span class="text-gray-500">BENCH</span> <span class="text-lg text-gray-500">v30.0</span></h1>
                    <p class="text-gray-400 text-xs tracking-[0.5em] font-bold">HIERARCHY FIX EDITION</p>
                </div>
                <div class="text-right">
                    <div class="text-[10px] text-gray-500 font-bold">DETECTED SILICON</div>
                    <div id="sys-info-preview" class="text-xl font-cyber text-white text-right">Scanning...</div>
                </div>
            </div>

            <div class="menu-grid">
                <div class="menu-item border-t-2 border-t-[var(--brand-yellow)]">
                    <div class="text-[var(--brand-yellow)] font-bold text-lg mb-1">01. PRIME CORE</div>
                    <p class="text-[9px] text-gray-400">Single-Threaded Burst (Main Thread).</p>
                </div>
                <div class="menu-item border-t-2 border-t-[var(--brand-green)]">
                    <div class="text-[var(--brand-green)] font-bold text-lg mb-1">02. MEMORY BW</div>
                    <p class="text-[9px] text-gray-400">RAM Speed & Compression.</p>
                </div>
                <div class="menu-item border-t-2 border-t-[var(--brand-ai)]">
                    <div class="text-[var(--brand-ai)] font-bold text-lg mb-1">03. ML TENSOR</div>
                    <p class="text-[9px] text-gray-400">70B LLM Inference Sim (25s).</p>
                </div>
                <div class="menu-item border-t-2 border-t-[var(--brand-secondary)]">
                    <div class="text-[var(--brand-secondary)] font-bold text-lg mb-1">04. GPU HEAVY</div>
                    <p class="text-[9px] text-gray-400">Native 8K Raymarching (25s).</p>
                </div>
                <div class="menu-item border-t-2 border-t-[var(--brand-primary)]">
                    <div class="text-[var(--brand-primary)] font-bold text-lg mb-1">05. CHAOS</div>
                    <p class="text-[9px] text-gray-400">System Stability Test (30s).</p>
                </div>
            </div>

            <div class="mb-8">
                <button id="btn-oc" onclick="app.toggleOverclock()" class="btn-oc px-6 py-6 w-full font-cyber text-2xl tracking-widest flex items-center justify-center gap-4 group transition-all">
                    <span id="oc-status-light" class="w-4 h-4 rounded-full bg-red-900 border border-red-500 group-hover:bg-red-500 animate-pulse"></span>
                    OVERCLOCK MODE: OFF
                </button>
            </div>

            <button onclick="app.start()" class="btn-main w-full py-6 text-xl font-bold tracking-widest hover:scale-[1.01] active:scale-[0.99] transition-transform">
                START HIERARCHY RUN
            </button>
        </div>

        <!-- HUD -->
        <div id="panel-hud" class="panel absolute bottom-10 w-[95%] max-w-6xl p-6 hidden border-b-4 border-b-white">
            <div class="flex justify-between items-end mb-4">
                <div>
                    <h2 id="hud-title" class="font-cyber text-3xl text-white animate-pulse">INITIALIZING</h2>
                    <p id="hud-sub" class="text-xs text-gray-400 font-mono uppercase tracking-widest">System Check...</p>
                </div>
                <div class="text-right">
                    <div class="text-[10px] text-gray-500">ELAPSED TIME</div>
                    <div id="timer" class="text-4xl font-mono text-white">0.00s</div>
                </div>
            </div>
            <div class="progress-track"><div id="progress-bar" class="progress-fill"></div></div>
            
            <div class="grid grid-cols-5 gap-4 mt-6 pt-6 border-t border-gray-800 text-center">
                <div class="border-r border-gray-800">
                    <div class="text-[9px] text-gray-500 mb-1">PRIME CORE</div>
                    <div id="score-live-prod" class="text-lg font-bold text-gray-600 font-mono">---</div>
                </div>
                <div class="border-r border-gray-800">
                    <div class="text-[9px] text-gray-500 mb-1">MEMORY</div>
                    <div id="score-live-create" class="text-lg font-bold text-gray-600 font-mono">---</div>
                </div>
                <div class="border-r border-gray-800">
                    <div class="text-[9px] text-gray-500 mb-1">AI TENSOR</div>
                    <div id="score-live-ml" class="text-lg font-bold text-gray-600 font-mono">---</div>
                </div>
                <div class="border-r border-gray-800">
                    <div class="text-[9px] text-gray-500 mb-1">GPU SCORE</div>
                    <div id="score-live-gpu" class="text-lg font-bold text-gray-600 font-mono">---</div>
                </div>
                <div>
                    <div class="text-[9px] text-red-500 mb-1 font-bold">CHAOS</div>
                    <div id="score-live-chaos" class="text-lg font-bold text-gray-600 font-mono">---</div>
                </div>
            </div>
        </div>

        <!-- SEARCHING OVERLAY -->
        <div id="panel-search" class="panel w-full max-w-md p-8 text-center hidden fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-50">
            <div class="text-[var(--brand-secondary)] font-cyber text-2xl mb-4">PROCESSING NEURAL DATA...</div>
            <div id="search-log" class="text-left h-32 overflow-hidden mb-4 bg-black/30 p-2 border border-gray-800"></div>
            <div class="w-full bg-gray-800 h-1 overflow-hidden">
                <div class="search-bar"></div>
            </div>
        </div>

        <!-- RESULTS -->
        <div id="panel-results" class="panel w-full max-w-6xl p-12 text-center hidden">
            <div class="flex justify-between items-start mb-8">
                <div class="text-left">
                    <div class="text-xs tracking-[1em] text-gray-500 mb-2 font-cyber">HARDWARE PROFILE</div>
                    <div class="text-sm text-white font-mono bg-black/50 p-4 border border-gray-800 rounded">
                        <div>GPU: <span id="hw-gpu" class="text-[var(--brand-secondary)]">...</span></div>
                        <div>OS: <span id="hw-os" class="text-[var(--brand-ai)]">...</span></div>
                        <div>Threads: <span id="hw-cores" class="text-white">...</span></div>
                        <div>Config: <span id="hw-config" class="text-[var(--brand-primary)] font-bold">...</span></div>
                    </div>
                </div>
                <div class="text-right">
                    <div class="text-xs tracking-[1em] text-gray-500 mb-2 font-cyber">MACHINE CLASS</div>
                    <div id="final-rank" class="text-3xl text-white font-black font-cyber tracking-wider animate-pulse">NEURAL ANALYSIS...</div>
                </div>
            </div>
            
            <div class="mb-8 relative">
                <div id="final-score" class="font-cyber text-9xl text-white mb-4 drop-shadow-[0_0_30px_rgba(255,255,255,0.4)]">0</div>
                <div id="final-desc" class="text-sm text-gray-400 font-mono mt-4 max-w-3xl mx-auto border-t border-gray-800 pt-4 leading-relaxed">
                    Connecting to global database to identify device signature...
                </div>
            </div>

            <div class="grid grid-cols-5 gap-4 mb-8">
                <div class="score-box border-t-4 border-t-[var(--brand-yellow)]">
                    <div class="text-[10px] text-[var(--brand-yellow)] mb-2 font-bold">PRIME CORE</div>
                    <div id="res-final-prod" class="text-xl font-bold text-white font-mono">0</div>
                </div>
                <div class="score-box border-t-4 border-t-[var(--brand-green)]">
                    <div class="text-[10px] text-[var(--brand-green)] mb-2 font-bold">MEMORY</div>
                    <div id="res-final-create" class="text-xl font-bold text-white font-mono">0</div>
                </div>
                <div class="score-box border-t-4 border-t-[var(--brand-ai)]">
                    <div class="text-[10px] text-[var(--brand-ai)] mb-2 font-bold">AI TENSOR</div>
                    <div id="res-final-ml" class="text-xl font-bold text-white font-mono">0</div>
                </div>
                <div class="score-box border-t-4 border-t-[var(--brand-secondary)]">
                    <div class="text-[10px] text-[var(--brand-secondary)] mb-2 font-bold">GPU</div>
                    <div id="res-final-gpu" class="text-xl font-bold text-white font-mono">0</div>
                </div>
                <div class="score-box border-t-4 border-t-red-600">
                    <div class="text-[10px] text-red-500 mb-2 font-bold">CHAOS</div>
                    <div id="res-final-chaos" class="text-xl font-bold text-white font-mono">0</div>
                </div>
            </div>

            <!-- REBOOT BUTTON ONLY -->
            <div class="flex gap-4 justify-center">
                <button onclick="location.reload()" class="btn-main px-8 py-4 text-lg">REBOOT</button>
            </div>
        </div>

    </div>

    <div id="tile-container" class="absolute inset-0 pointer-events-none z-20"></div>

    <script>
        const CORES = navigator.hardwareConcurrency || 8;
        const apiKey = ""; 

        // --- SILICON KNOWLEDGE GRAPH (FALLBACK) ---
        class KnowledgeBase {
            static identify(gpu, os, threads, score, isTouch, width, height) {
                const g = gpu.toLowerCase();
                
                if (g.includes("intel") || g.includes("arc") || g.includes("iris")) {
                    if (threads >= 20) return "Intel Core Ultra 9 / i9";
                    if (threads >= 14) return "Intel Core Ultra 7 / i7";
                    if (threads >= 8) return "Intel Core i5 / Ultra 5";
                    return "Intel Core (Standard)";
                }
                
                if (g.includes("apple")) {
                    const maxDim = Math.max(width, height);
                    
                    if (isTouch) {
                        if (maxDim <= 1100) return "Apple A-Series (iPad 8th/9th Gen)";
                        if (score > 800000) return "Apple M4 (iPad Pro)";
                        if (score > 500000) return "Apple M1/M2 (iPad Air/Pro)";
                        return "Apple A-Series (iPad Air/Mini)";
                    } else {
                        if (score > 1000000) return "Apple M3 Max / Ultra";
                        if (score > 500000) return "Apple M2/M3 Pro";
                        return "Apple M1/M2/M3 (Mac)";
                    }
                }
                
                if (g.includes("nvidia") || g.includes("geforce")) {
                    if (score > 1500000) return "NVIDIA RTX 4090";
                    if (score > 1000000) return "NVIDIA RTX 4080 / 4070 Ti";
                    if (score > 500000) return "NVIDIA RTX 4060 / 3070";
                    return "NVIDIA RTX Series";
                }
                
                if (g.includes("adreno")) {
                    if (score > 800000) return "Snapdragon 8 Gen 3";
                    if (score > 500000) return "Snapdragon 8 Gen 2";
                    return "Qualcomm Snapdragon";
                }
                
                return "Unknown Architecture";
            }
        }

        const SYS = {
            gpu: "Unknown",
            os: "Unknown",
            threads: CORES,
            isTouch: navigator.maxTouchPoints > 0,
            resW: window.screen.width, 
            resH: window.screen.height
        };

        try {
            const c = document.createElement('canvas');
            const gl = c.getContext('webgl') || c.getContext('experimental-webgl');
            const dbg = gl.getExtension('WEBGL_debug_renderer_info');
            if(dbg) SYS.gpu = gl.getParameter(dbg.UNMASKED_RENDERER_WEBGL);
        } catch(e){}

        const userAgentStr = navigator.userAgent;
        if (userAgentStr.includes("Win")) SYS.os = "Windows";
        else if (userAgentStr.includes("Mac")) SYS.os = (SYS.isTouch) ? "iPadOS" : "macOS";
        else if (userAgentStr.includes("Linux")) SYS.os = "Linux";
        else if (userAgentStr.includes("Android")) SYS.os = "Android";
        else if (userAgentStr.includes("iPhone")) SYS.os = "iOS";

        document.getElementById('sys-info-preview').innerText = `${SYS.os} | ${SYS.threads} Threads`;

        const UI = {
            menu: document.getElementById('panel-menu'),
            hud: document.getElementById('panel-hud'),
            search: document.getElementById('panel-search'),
            log: document.getElementById('search-log'),
            results: document.getElementById('panel-results'),
            title: document.getElementById('hud-title'),
            sub: document.getElementById('hud-sub'),
            timer: document.getElementById('timer'),
            bar: document.getElementById('progress-bar'),
            tileContainer: document.getElementById('tile-container'),
            cpuCanvas: document.getElementById('cpu-canvas'),
            gpuOverlay: document.getElementById('gpu-overlay'),
            btnOc: document.getElementById('btn-oc'),
            scores: {
                prod: document.getElementById('score-live-prod'),
                create: document.getElementById('score-live-create'),
                ml: document.getElementById('score-live-ml'),
                gpu: document.getElementById('score-live-gpu'),
                chaos: document.getElementById('score-live-chaos')
            },
            finalScore: document.getElementById('final-score'),
            finalRank: document.getElementById('final-rank'),
            finalDesc: document.getElementById('final-desc'),
            resProd: document.getElementById('res-final-prod'),
            resCreate: document.getElementById('res-final-create'),
            resMl: document.getElementById('res-final-ml'),
            resGpu: document.getElementById('res-final-gpu'),
            resChaos: document.getElementById('res-final-chaos'),
            hwGpu: document.getElementById('hw-gpu'),
            hwOs: document.getElementById('hw-os'),
            hwCores: document.getElementById('hw-cores'),
            hwConfig: document.getElementById('hw-config')
        };

        class CyberBench {
            constructor() {
                this.overclock = false;
                this.scores = { prod: 0, create: 0, ml: 0, gpu: 0, chaos: 0 };
                this.startTime = 0;
                this.cpuW = 3840; this.cpuH = 2160;
                UI.cpuCanvas.width = this.cpuW;
                UI.cpuCanvas.height = this.cpuH;
                this.ctx = UI.cpuCanvas.getContext('2d');
                this.gpuTestRes = "Unknown";
            }

            toggleOverclock() {
                this.overclock = !this.overclock;
                if(this.overclock) {
                    UI.btnOc.classList.add('active');
                    UI.btnOc.innerHTML = `[ !!! ] OVERCLOCK MODE: ACTIVE`;
                } else {
                    UI.btnOc.classList.remove('active');
                    UI.btnOc.innerHTML = `OVERCLOCK MODE: OFF`;
                }
            }

            start() {
                UI.menu.classList.add('hidden');
                UI.hud.classList.remove('hidden');
                this.totalStart = performance.now();
                this.runSuite();
            }

            updateLiveScore(type, val) {
                UI.scores[type].innerText = Math.floor(val).toLocaleString();
                UI.scores[type].classList.remove('text-gray-600');
                UI.scores[type].classList.add('text-white');
            }

            setPhaseUI(title, sub, color) {
                UI.title.innerText = title;
                UI.sub.innerText = sub;
                UI.title.style.color = color;
                UI.bar.style.backgroundColor = color;
                UI.bar.style.width = "0%";
                UI.hud.style.borderColor = color;
            }

            async runSuite() {
                await this.runSingleCorePeak(); // New Prime Core Test
                await this.runMemoryBandwidth(); // New Memory Test
                await this.runHeavyAI(); 
                await this.runVolumetricGpu();   
                this.runChaosMode();
            }

            // 1. PRIME CORE (SINGLE THREADED BURST)
            // Runs on MAIN thread to force OS to use Cortex-X4 / P-Core
            runSingleCorePeak() {
                return new Promise(resolve => {
                    this.setPhaseUI("PRIME CORE", "Single-Threaded Burst (Cortex-X4)...", "#facc15");
                    const start = performance.now();
                    const duration = 8000; 
                    let ops = 0;
                    
                    // Main thread loop (chunks to avoid hanging UI completely)
                    const processChunk = () => {
                        const now = performance.now();
                        if (now - start > duration) {
                            this.scores.prod = Math.floor(ops / 30000); // Scaled for Single Core
                            this.updateLiveScore('prod', this.scores.prod);
                            resolve();
                            return;
                        }
                        
                        // Heavy Single Core Math
                        const chunkEnd = now + 15; // 15ms slice
                        while (performance.now() < chunkEnd) {
                            Math.sqrt(Math.random() * 1000000);
                            Math.pow(Math.sin(Math.random()), 2);
                            ops++;
                        }
                        
                        // UI Update
                        UI.bar.style.width = `${((now - start)/duration)*100}%`;
                        UI.timer.innerText = ((now - this.totalStart)/1000).toFixed(2) + 's';
                        requestAnimationFrame(processChunk);
                    };
                    processChunk();
                });
            }
            
            // 2. MEMORY BANDWIDTH (RAM Speed)
            // Huge array copies to test LPDDR5X vs LPDDR4X
            runMemoryBandwidth() {
                return new Promise((resolve) => {
                    this.setPhaseUI("MEMORY BW", "RAM Throughput & Compression...", "#10b981");
                    const duration = 12000;
                    const start = performance.now();
                    const threads = CORES;
                    let completed = 0, totalBytes = 0;

                    const blob = new Blob([`
                        self.onmessage = function(e) {
                            const dur = e.data;
                            const end = Date.now() + dur;
                            // 16MB Buffer
                            const buffer = new Float32Array(4 * 1024 * 1024); 
                            
                            while(Date.now() < end) {
                                // Write
                                for(let i=0; i<buffer.length; i+=16) buffer[i] = Math.random();
                                // Copy (Bandwidth)
                                const copy = buffer.slice(0);
                                self.postMessage(buffer.byteLength * 2); // Read + Write
                            }
                        }
                    `], {type: 'application/javascript'});
                    const url = URL.createObjectURL(blob);

                    const tInt = setInterval(() => {
                        const elapsed = performance.now() - start;
                        UI.timer.innerText = (elapsed/1000).toFixed(2) + 's';
                        UI.bar.style.width = `${(elapsed/duration)*100}%`;
                    }, 50);

                    for(let i=0; i<threads; i++) {
                        const w = new Worker(url);
                        w.onmessage = (e) => { totalBytes += e.data; };
                        w.postMessage(duration);
                        setTimeout(() => {
                            w.terminate();
                            completed++;
                            if (completed === threads) {
                                clearInterval(tInt);
                                // Score based on GB/s throughput
                                this.scores.create = Math.floor(totalBytes / 100000000); 
                                this.updateLiveScore('create', this.scores.create);
                                resolve();
                            }
                        }, duration + 200);
                    }
                });
            }
            
            // 3. HEAVY AI - REDUCED SCORE (Divisor increased from 100k to 200k)
            runHeavyAI() { 
                return new Promise(resolve => {
                    this.setPhaseUI("HEAVY AI", "70B LLM Inference Sim...", "#bc13fe");
                    const start = performance.now();
                    const blob = new Blob([`self.onmessage=function(e){const end=Date.now()+e.data;let ops=0;while(Date.now()<end){Math.sin(Math.random());ops++;}self.postMessage(ops);}`], {type:'application/javascript'});
                    const url = URL.createObjectURL(blob);
                    const workers = [];
                    for(let i=0; i<CORES; i++) { const w=new Worker(url); w.postMessage(25000); workers.push(w); }
                    let total = 0; workers.forEach(w => w.onmessage = (e) => total += e.data);
                    const tInt = setInterval(() => {
                        UI.timer.innerText = ((performance.now()-start)/1000).toFixed(2) + 's';
                        UI.bar.style.width = `${((performance.now()-start)/25000)*100}%`;
                    }, 50);
                    setTimeout(() => {
                        clearInterval(tInt); workers.forEach(w => w.terminate());
                        // DIVISOR 200,000
                        this.scores.ml = Math.floor(total / 200000); 
                        this.updateLiveScore('ml', this.scores.ml);
                        resolve();
                    }, 25500);
                });
            }

            // HELPER
            genericCpuTest(title, sub, color, duration, key, factor) {
                return new Promise(resolve => {
                    this.setPhaseUI(title, sub, color);
                    const start = performance.now();
                    const blob = new Blob([`
                        self.onmessage = function(e) {
                            const end = Date.now() + e.data;
                            let ops = 0;
                            while(Date.now() < end) {
                                Math.random() * Math.random();
                                JSON.parse(JSON.stringify({a:1}));
                                ops++;
                            }
                            self.postMessage(ops);
                        }
                    `], {type:'application/javascript'});
                    const url = URL.createObjectURL(blob);
                    const workers = [];
                    for(let i=0; i<CORES; i++) { const w=new Worker(url); w.postMessage(duration); workers.push(w); }
                    
                    let total = 0;
                    workers.forEach(w => w.onmessage = (e) => total += e.data);

                    const tInt = setInterval(() => {
                        const el = performance.now() - start;
                        UI.timer.innerText = (el/1000).toFixed(2) + 's';
                        UI.bar.style.width = `${(el/duration)*100}%`;
                    }, 50);

                    setTimeout(() => {
                        clearInterval(tInt);
                        workers.forEach(w => w.terminate());
                        this.scores[key] = Math.floor(total / factor);
                        this.updateLiveScore(key, this.scores[key]);
                        resolve();
                    }, duration + 500);
                });
            }

            // 4. GPU VOLUMETRIC - BOOSTED SCORE (Multiplier increased to 200/100)
            runVolumetricGpu() {
                return new Promise((resolve) => {
                    UI.gpuOverlay.style.opacity = 1;
                    const scene = new THREE.Scene();
                    const camera = new THREE.OrthographicCamera(-1, 1, 1, -1, 0, 1);
                    const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: false, precision: "highp" });
                    UI.gpuOverlay.appendChild(renderer.domElement);

                    let width = 7680, height = 4320;
                    let resLabel = "8K";
                    let scorePenalty = 1.0;

                    const maxTex = renderer.capabilities.maxTextureSize;
                    const maxRender = renderer.capabilities.maxRenderBufferSize || 4096;
                    
                    if (maxTex < 8192 || maxRender < 4320) {
                        width = 3840; height = 2160; resLabel = "4K"; scorePenalty = 0.6;
                    }

                    try {
                        renderer.setSize(width, height);
                    } catch(e) {
                        width = 3840; height = 2160; resLabel = "4K (Fallback)"; scorePenalty = 0.5;
                        try { renderer.setSize(width, height); }
                        catch(e2) { width = 1920; height = 1080; resLabel = "1080p (Safe)"; scorePenalty = 0.25; renderer.setSize(width, height); }
                    }

                    this.gpuTestRes = resLabel;
                    this.setPhaseUI(`GPU ${resLabel}`, "Volumetric Cloud Shader...", "#00f3ff");

                    let iterations = this.overclock ? 2000 : 800;
                    
                    // Increase complexity for high-end mobile GPUs
                    iterations *= 2.0; 

                    const frag = `
                        uniform float time; uniform vec2 resolution;
                        float hash(float n) { return fract(sin(n) * 43758.5453); }
                        float noise(vec3 x) {
                            vec3 p = floor(x); vec3 f = fract(x);
                            f = f * f * (3.0 - 2.0 * f);
                            float n = p.x + p.y * 57.0 + 113.0 * p.z;
                            return mix(mix(mix(hash(n + 0.0), hash(n + 1.0), f.x),
                                           mix(hash(n + 57.0), hash(n + 58.0), f.x), f.y),
                                       mix(mix(hash(n + 113.0), hash(n + 114.0), f.x),
                                           mix(hash(n + 170.0), hash(n + 171.0), f.x), f.y), f.z);
                        }
                        float map(vec3 p) {
                            vec3 q = p - vec3(0.0, 0.5, 1.0) * time;
                            float f = 0.0; float scale = 0.5;
                            for(int i=0; i<4; i++) { f += scale * noise(q); q *= 2.0; scale *= 0.5; }
                            return f;
                        }
                        void main() {
                            vec2 uv = (gl_FragCoord.xy * 2.0 - resolution) / resolution.y;
                            vec3 ro = vec3(0.0, 0.0, 2.0); vec3 rd = normalize(vec3(uv, -1.0));
                            vec4 sum = vec4(0.0); float t = 0.0;
                            for(int i=0; i<100; i++) {
                                vec3 pos = ro + t * rd;
                                float d = map(pos * 2.0);
                                if(d > 0.4) {
                                    float dif = clamp((d - map(pos + 0.3)) / 0.3, 0.0, 1.0);
                                    vec4 col = vec4(vec3(1.0, 0.5, 0.2) * dif + 0.1, 0.1);
                                    col.rgb *= col.a; sum = sum + col * (1.0 - sum.a);
                                }
                                t += 0.1;
                                if(sum.a > 0.99) break;
                            }
                            gl_FragColor = sum;
                        }
                    `;
                    const mat = new THREE.ShaderMaterial({
                        uniforms: { time: {value: 0}, resolution: {value: new THREE.Vector2(width, height)} },
                        fragmentShader: frag
                    });
                    scene.add(new THREE.Mesh(new THREE.PlaneGeometry(2,2), mat));

                    const duration = 25000;
                    const start = performance.now();
                    let frames = 0;

                    const animate = () => {
                        const elapsed = performance.now() - start;
                        if(elapsed > duration) {
                            renderer.dispose();
                            UI.gpuOverlay.innerHTML = '';
                            // DEFLATION: Multiplier decreased 100x
                            let rawScore = frames * (this.overclock ? 20 : 10);
                            this.scores.gpu = Math.floor(rawScore * scorePenalty);
                            this.updateLiveScore('gpu', this.scores.gpu);
                            resolve(); return;
                        }
                        mat.uniforms.time.value = elapsed / 1000;
                        renderer.render(scene, camera); frames++;
                        UI.bar.style.width = `${(elapsed/duration)*100}%`;
                        UI.timer.innerText = (elapsed/1000).toFixed(2) + 's';
                        let currentEst = Math.floor(frames * (this.overclock ? 20 : 10) * (duration/elapsed) * scorePenalty);
                        this.updateLiveScore('gpu', currentEst);
                        requestAnimationFrame(animate);
                    };
                    animate();
                });
            }

            // 5. CHAOS - 100x DEFLATION
            runChaosMode() {
                this.setPhaseUI("CHAOS MODE", "MAX POWER: CPU + GPU (30s)", "#ff003c");
                UI.cpuCanvas.style.opacity = 0.5; UI.gpuOverlay.style.opacity = 0.5;
                const ren = this.setupGpu(3840,2160);
                const blob = new Blob([`self.onmessage=function(){const e=Date.now()+30000;while(Date.now()<e){Math.random()}}`],{type:'application/javascript'});
                const url = URL.createObjectURL(blob);
                for(let i=0;i<CORES;i++) new Worker(url).postMessage('go');
                
                let frames=0; const start=performance.now(); const dur=30000;
                const loop = () => {
                    if(performance.now()-start>dur) {
                        ren.renderer.dispose(); UI.gpuOverlay.innerHTML='';
                        // Multiplier 0.006
                        this.scores.chaos = Math.floor(frames * (this.overclock ? 0.006 : 0.004));
                        this.updateLiveScore('chaos', this.scores.chaos);
                        this.analyzeWithAI(); return;
                    }
                    ren.renderer.render(ren.scene, ren.camera); frames++;
                    UI.bar.style.width = `${((performance.now()-start)/dur)*100}%`;
                    UI.timer.innerText = ((performance.now()-this.totalStart)/1000).toFixed(2)+'s';
                    this.updateLiveScore('chaos', Math.floor(frames * (this.overclock ? 0.006 : 0.004)));
                    requestAnimationFrame(loop);
                };
                loop();
            }

            setupGpu(w,h) {
                const s=new THREE.Scene(); const c=new THREE.OrthographicCamera(-1,1,1,-1,0,1);
                const r=new THREE.WebGLRenderer({alpha:true}); r.setSize(w,h); UI.gpuOverlay.appendChild(r.domElement);
                const m = new THREE.MeshBasicMaterial({color:0xff0000, wireframe:true});
                s.add(new THREE.Mesh(new THREE.PlaneGeometry(2,2,10,10), m));
                return {scene:s, camera:c, renderer:r};
            }

            // --- AI INTEGRATION ---
            async analyzeWithAI() {
                UI.hud.classList.add('hidden');
                UI.search.classList.remove('hidden');
                UI.search.querySelector('div').innerText = "GEMINI NEURAL ANALYSIS...";
                
                const total = Object.values(this.scores).reduce((a,b)=>a+b,0);
                
                const prompt = `
                    You are a highly technical Hardware Analyst AI. 
                    Analyze these CyberBench scores and the device fingerprint to identify the specific device and its performance class.

                    DEVICE FINGERPRINT:
                    - OS: ${SYS.os} (e.g., Windows, iPadOS, Android)
                    - GPU String: ${SYS.gpu} (e.g., "ANGLE (Intel, Intel(R) Arc(TM)...)", "Apple GPU")
                    - CPU Cores: ${SYS.threads} Logical Threads
                    - Touchscreen: ${SYS.isTouch}
                    - Resolution used for GPU Test: ${this.gpuTestRes}
                    - Logical Screen Resolution: ${SYS.resW}x${SYS.resH}

                    BENCHMARK SCORES (Hierarchy Fix Scale):
                    - Prime Core (Single Thread): ${this.scores.prod} (Most important for Dimensity vs Snapdragon)
                    - Memory (Bandwidth): ${this.scores.create} (High means LPDDR5X)
                    - AI Tensor Inference: ${this.scores.ml}
                    - GPU Graphics: ${this.scores.gpu}
                    - Chaos (Thermal Load): ${this.scores.chaos}
                    - TOTAL SCORE: ${total}

                    LEARNED KNOWLEDGE (Hierarchy Fix):
                    - Snapdragon 8s Gen 3 should have HIGH Prime Core score (>200k) due to Cortex-X4.
                    - Dimensity 7300 (Cortex-A78) should have LOWER Prime Core score (~120k).
                    - GPU: Adreno 735 (8s Gen 3) > Mali-G615 (Dimensity 7300).
                    - iPad 8 (A12): Scores ~100k - 150k total.

                    INSTRUCTIONS:
                    1. Identify the Device: Use GPU, Screen Res, and Score.
                       - If Android & Prime Core is High -> Snapdragon 8 Series.
                       - If Android & Prime Core is Mid -> Dimensity 7000/8000 Series.
                    2. Determine Class: "Budget", "Mid-Range", "Flagship", "Workstation".
                    3. Provide a 1-sentence summary.

                    RETURN JSON ONLY:
                    {
                        "rank": "DEVICE NAME",
                        "class": "CLASS NAME",
                        "desc": "Description string",
                        "is_integrated": boolean
                    }
                `;

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }],
                            generationConfig: { responseMimeType: "application/json" }
                        })
                    });
                    
                    const data = await response.json();
                    const result = JSON.parse(data.candidates[0].content.parts[0].text);
                    
                    this.finish(result);
                    
                } catch (e) {
                    const fallback = KnowledgeBase.identify(SYS.gpu, SYS.os, SYS.threads, total, SYS.isTouch, SYS.resW, SYS.resH);
                    this.finish({
                        rank: fallback,
                        class: "Standard Device",
                        desc: "AI Connection Failed. Using local silicon signatures.",
                        is_integrated: false
                    });
                }
            }

            finish(aiResult) {
                UI.search.classList.add('hidden');
                UI.results.classList.remove('hidden');
                
                const total = Object.values(this.scores).reduce((a,b)=>a+b,0);
                
                UI.finalScore.innerText = total.toLocaleString();
                UI.resProd.innerText = this.scores.prod.toLocaleString();
                UI.resCreate.innerText = this.scores.create.toLocaleString();
                UI.resMl.innerText = this.scores.ml.toLocaleString();
                UI.resGpu.innerText = this.scores.gpu.toLocaleString();
                UI.resChaos.innerText = this.scores.chaos.toLocaleString();
                UI.hwGpu.innerText = SYS.gpu.replace('ANGLE (','').replace(')','').substring(0,25);
                UI.hwOs.innerText = SYS.os;
                UI.hwCores.innerText = `${SYS.threads} Threads`;

                // Populate based on AI Result
                UI.finalRank.innerText = aiResult.class.toUpperCase();
                UI.finalDesc.innerText = `Identified: ${aiResult.rank}. ${aiResult.desc}`;
                
                let configStr = aiResult.is_integrated ? "Integrated Graphics" : "Discrete Graphics";
                if (aiResult.rank.includes("iPad") || aiResult.rank.includes("Tablet")) configStr = "Mobile Silicon";
                UI.hwConfig.innerText = configStr;

                if (aiResult.class.includes("Flagship") || aiResult.class.includes("Workstation")) {
                    UI.finalRank.style.color = "#ff003c"; 
                } else if (aiResult.class.includes("Gaming") || aiResult.class.includes("Pro")) {
                    UI.finalRank.style.color = "#00ff00";
                } else {
                    UI.finalRank.style.color = "#00d9ff";
                }
            }
        }

        const app = new CyberBench();
    </script>
</body>
</html>